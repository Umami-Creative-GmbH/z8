---
title: Services & Infrastructure
description: Notifications, storage, background jobs, analytics, and DateTime handling
icon: Cloud
---

import { Tabs, Tab } from 'fumadocs-ui/components/tabs';
import { Callout } from 'fumadocs-ui/components/callout';
import { File, Folder, Files } from 'fumadocs-ui/components/files';

## Notification System

### Multi-Channel Architecture

The notification system supports three delivery channels:

| Channel | Technology | Use Case |
|---------|------------|----------|
| **Email** | SMTP / Provider | Transactional emails |
| **Push** | Web Push API | Browser notifications |
| **In-App** | Server-Sent Events | Real-time updates |

### Push Notifications

<Tabs items={['Generate Keys', 'Configure']}>
  <Tab value="Generate Keys">
    ```bash
    bunx web-push generate-vapid-keys
    ```
  </Tab>
  <Tab value="Configure">
    ```ini
    VAPID_PUBLIC_KEY=<generated-public-key>
    VAPID_PRIVATE_KEY=<generated-private-key>
    VAPID_SUBJECT=mailto:support@yourdomain.com
    ```
  </Tab>
</Tabs>

### SSE Implementation

Real-time notifications use Server-Sent Events:
- Endpoint: `/api/notifications/sse`
- Auto-reconnection on disconnect
- Event types: `notification`, `status`, `heartbeat`

---

## Storage Infrastructure

### TUS Resumable Uploads

File uploads use the TUS protocol for reliable, resumable uploads:

- Large file support with chunking
- Resume interrupted uploads
- Progress tracking

### S3 Integration

Configure S3-compatible storage:

```ini
S3_BUCKET=your-bucket
S3_REGION=eu-central-1
S3_ACCESS_KEY_ID=<access-key>
S3_SECRET_ACCESS_KEY=<secret-key>
S3_ENDPOINT=https://s3.amazonaws.com  # Or compatible endpoint
```

---

## Background Jobs

### Cron Jobs

Background jobs are handled via cron endpoints:

| Job | Schedule | Description |
|-----|----------|-------------|
| `/api/cron/reminders` | Daily | Clock in/out reminders |
| `/api/cron/reports` | Weekly | Scheduled report generation |
| `/api/cron/cleanup` | Daily | Cleanup expired data |
| `/api/cron/export` | On-demand | Data export processing |

### Job Processing

```typescript
import { processExportJob } from '@/lib/jobs/export-processor';
```

### BullMQ Job Queue

For reliable background job processing, the system uses BullMQ with Valkey/Redis:

```typescript
import { Queue, Worker } from 'bullmq';

// Create a queue
const exportQueue = new Queue('exports', {
  connection: { host: 'localhost', port: 6379 }
});

// Add a job
await exportQueue.add('generate-report', {
  organizationId,
  reportType: 'time-entries',
  dateRange: { start, end }
});
```

#### Job Types

| Queue | Purpose |
|-------|---------|
| `exports` | Large data exports |
| `reports` | Scheduled report generation |
| `notifications` | Bulk notification delivery |
| `cleanup` | Data cleanup and maintenance |
| `webhooks` | Webhook delivery with retries |

#### Worker Configuration

```typescript
const worker = new Worker('exports', async (job) => {
  // Process the job
  await generateExport(job.data);
}, {
  connection: { host: 'localhost', port: 6379 },
  concurrency: 3
});
```

---

## Event Bus

The event bus provides internal pub/sub messaging for decoupled event handling across the application.

### Architecture

<Files>
  <Folder name="src/lib/events" defaultOpen>
    <File name="bus.ts" />
    <File name="types.ts" />
    <File name="subscribers.ts" />
    <File name="index.ts" />
  </Folder>
</Files>

### Publishing Events

```typescript
import { eventBus } from '@/lib/events';

// Emit an event when something happens
eventBus.emit('time_entry.clock_in', {
  employeeId,
  organizationId,
  timestamp: new Date(),
  metadata: { source: 'desktop' }
});
```

### Subscribing to Events

```typescript
import { eventBus } from '@/lib/events';

// Subscribe to handle events
eventBus.on('time_entry.clock_in', async (data) => {
  // Send notifications
  await notifyManagers(data);

  // Update dashboards
  await updateRealTimeDashboard(data);

  // Trigger webhooks (handled by webhook subscriber)
});
```

### Event Types

| Category | Events |
|----------|--------|
| **Time Entries** | `clock_in`, `clock_out`, `created`, `updated`, `deleted` |
| **Absences** | `requested`, `approved`, `denied`, `cancelled` |
| **Employees** | `created`, `updated`, `deactivated` |
| **Projects** | `created`, `budget_alert`, `deadline_approaching` |
| **System** | `export_ready`, `report_generated` |

---

## Webhook System

Webhooks deliver real-time notifications to external systems.

### Webhook Queue

<Files>
  <Folder name="src/lib/webhooks" defaultOpen>
    <File name="webhook-service.ts" />
    <File name="webhook-queue.ts" />
    <File name="webhook-worker.ts" />
    <File name="webhook-delivery.ts" />
    <File name="webhook-subscriber.ts" />
    <File name="signature.ts" />
    <File name="types.ts" />
  </Folder>
</Files>

### Delivery Flow

```
Event occurs (e.g., clock in)
    ↓
Event bus emits event
    ↓
Webhook subscriber receives event
    ↓
Find matching webhook endpoints
    ↓
Queue delivery jobs in BullMQ
    ↓
Worker processes deliveries
    ↓
Sign payload with HMAC-SHA256
    ↓
POST to webhook URL
    ↓
Retry on failure (exponential backoff)
```

### Retry Strategy

| Attempt | Delay |
|---------|-------|
| 1 | Immediate |
| 2 | 1 second |
| 3 | 5 seconds |
| 4 | 30 seconds |
| 5 | 2 minutes |
| 6 | 10 minutes |

### Webhook Payload

```typescript
interface WebhookPayload {
  id: string;           // Unique delivery ID
  type: string;         // Event type
  createdAt: string;    // ISO timestamp
  data: {               // Event-specific data
    // Varies by event type
  }
}
```

### Signature Verification

Payloads include an HMAC-SHA256 signature in the `X-Webhook-Signature` header:

```typescript
// Verify incoming webhook
import crypto from 'crypto';

const signature = request.headers['x-webhook-signature'];
const expected = crypto
  .createHmac('sha256', webhookSecret)
  .update(JSON.stringify(body))
  .digest('hex');

const isValid = crypto.timingSafeEqual(
  Buffer.from(signature),
  Buffer.from(expected)
);
```

### Auto-Disable

Endpoints are automatically disabled after 10 consecutive failures to prevent resource waste.

---

## Rate Limiting

### @upstash/ratelimit Integration

API endpoints are protected with rate limiting using `@upstash/ratelimit`:

```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '10 s'),
});

// In API route
const { success, limit, remaining } = await ratelimit.limit(identifier);
```

#### Rate Limit Tiers

| Endpoint Type | Limit | Window |
|---------------|-------|--------|
| Authentication | 5 | 1 minute |
| API Read | 100 | 1 minute |
| API Write | 30 | 1 minute |
| Exports | 5 | 1 hour |

---

## Real-Time Infrastructure

### Valkey Pub/Sub

Real-time notifications use Valkey (Redis-compatible) pub/sub:

```typescript
import { createClient } from 'redis';

const publisher = createClient({ url: process.env.VALKEY_URL });
const subscriber = createClient({ url: process.env.VALKEY_URL });

// Publish notification
await publisher.publish('notifications', JSON.stringify({
  userId,
  type: 'approval-request',
  data: { ... }
}));

// Subscribe in SSE handler
await subscriber.subscribe('notifications', (message) => {
  const notification = JSON.parse(message);
  // Send to appropriate SSE connection
});
```

#### Channel Structure

| Channel | Purpose |
|---------|---------|
| `notifications:{userId}` | User-specific notifications |
| `organization:{orgId}` | Organization-wide broadcasts |
| `presence:{orgId}` | User presence tracking |

---

## DateTime Handling

### Luxon Integration

All date/time operations use Luxon for timezone-aware handling:

<Tabs items={['Create', 'Format', 'Convert']}>
  <Tab value="Create">
    ```typescript
    import { DateTime } from 'luxon';

    // Create with timezone
    const dt = DateTime.now().setZone('Europe/Berlin');
    ```
  </Tab>
  <Tab value="Format">
    ```typescript
    // Format for display
    dt.toFormat('dd.MM.yyyy HH:mm');

    // ISO format for API
    dt.toISO();
    ```
  </Tab>
  <Tab value="Convert">
    ```typescript
    // Convert to user's timezone
    toLocalTime(date, userTimezone);

    // Convert to UTC for storage
    toUTC(date);
    ```
  </Tab>
</Tabs>

### Utilities

Custom utilities in `src/lib/datetime/`:
- `toLocalTime()` - Convert to user's timezone
- `toUTC()` - Convert to UTC for storage
- `formatDuration()` - Human-readable duration
- `getWorkingDays()` - Calculate business days

---

## Email Templates

### React Email

Email templates use React Email for consistent styling:

<Files>
  <Folder name="src/lib/email/templates" defaultOpen>
    <File name="welcome.tsx" />
    <File name="approval-request.tsx" />
    <File name="approval-response.tsx" />
    <File name="time-reminder.tsx" />
    <File name="export-ready.tsx" />
    <File name="export-failed.tsx" />
  </Folder>
</Files>

### Rendering

```typescript
import { render } from '@/lib/email/render';
import { WelcomeEmail } from '@/lib/email/templates/welcome';

const html = await render(WelcomeEmail, { name: 'John' });
```

---

## Analytics Service

### Team Performance Metrics

The analytics service provides:

- Work hours by team/employee
- Overtime trends and patterns
- Vacation usage and balance
- Attendance metrics

### API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /api/analytics/team-performance` | Team performance metrics |
| `GET /api/analytics/vacation-trends` | Vacation usage trends |
| `GET /api/analytics/work-hours` | Work hours summary |
| `GET /api/analytics/export` | Export analytics data |
